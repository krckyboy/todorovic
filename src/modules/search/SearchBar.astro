---
/**
 * SearchBar - Main entry point for the search feature
 *
 * Composes SearchButton, SearchModal, SearchInput, and SearchResults
 * and coordinates state between them via custom events.
 */
import SearchButton from './components/SearchButton.astro';
import SearchModal from './components/SearchModal.astro';
import SearchInput from './components/SearchInput.astro';
import SearchResults from './components/SearchResults.astro';
---

<SearchButton />

<SearchModal>
  <SearchInput />
  <SearchResults />
</SearchModal>

<script is:inline>
  let pagefind = null;
  let isOpen = false;

  const searchButton = document.getElementById('search-button');

  // Initialize Pagefind with lazy loading
  async function initPagefind() {
    if (pagefind) return pagefind;
    try {
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
      return pagefind;
    } catch (error) {
      console.error('Failed to load Pagefind:', error);
      return null;
    }
  }

  // Perform search
  async function performSearch(query) {
    const pf = await initPagefind();
    if (!pf) return [];
    try {
      const response = await pf.search(query);
      return Promise.all(response.results.slice(0, 10).map(r => r.data()));
    } catch (error) {
      console.error('Search error:', error);
      return [];
    }
  }

  // Open modal
  function openSearch() {
    if (isOpen) return;
    isOpen = true;
    window.dispatchEvent(new CustomEvent('search:open'));
    initPagefind();
  }

  // Close modal
  function closeSearch() {
    if (!isOpen) return;
    isOpen = false;
    window.dispatchEvent(new CustomEvent('search:close'));
    searchButton?.focus();
  }

  // Handle search query
  async function handleQuery(query) {
    if (!query.trim()) {
      window.dispatchEvent(new CustomEvent('search:results', { detail: { results: [], query } }));
      return;
    }

    window.dispatchEvent(new CustomEvent('search:loading'));

    const results = await performSearch(query);
    window.dispatchEvent(new CustomEvent('search:results', { detail: { results, query } }));
  }

  // Event listeners
  searchButton?.addEventListener('click', openSearch);

  window.addEventListener('search:close', closeSearch);

  window.addEventListener('search:query', (e) => {
    handleQuery(e.detail.query);
  });

  // Global keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Cmd/Ctrl + K to toggle
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      isOpen ? closeSearch() : openSearch();
      return;
    }

    if (!isOpen) return;

    // Escape to close
    if (e.key === 'Escape') {
      e.preventDefault();
      closeSearch();
      return;
    }

    // Arrow keys for navigation
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      window.dispatchEvent(new CustomEvent('search:navigate', { detail: { direction: 'down' } }));
      return;
    }

    if (e.key === 'ArrowUp') {
      e.preventDefault();
      window.dispatchEvent(new CustomEvent('search:navigate', { detail: { direction: 'up' } }));
      return;
    }

    // Enter to select
    if (e.key === 'Enter') {
      e.preventDefault();
      window.dispatchEvent(new CustomEvent('search:navigate', { detail: { direction: 'select' } }));
    }
  });
</script>
