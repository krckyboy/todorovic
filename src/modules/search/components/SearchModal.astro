---
import styles from './SearchModal.module.css';

const styleClasses = JSON.stringify({
  open: styles.open,
});
---

<div class={styles.overlay} id="search-overlay" role="presentation">
  <div
    class={styles.modal}
    role="dialog"
    aria-modal="true"
    aria-label="Site search"
    id="search-modal"
  >
    <slot />
  </div>
</div>

<script id="modal-styles" type="application/json" set:html={styleClasses} />

<script is:inline>
  const modalStylesScript = document.getElementById('modal-styles');
  const modalStyles = modalStylesScript ? JSON.parse(modalStylesScript.textContent || '{}') : {};

  const overlay = document.getElementById('search-overlay');
  const modal = document.getElementById('search-modal');

  // Close on overlay click
  overlay?.addEventListener('click', (e) => {
    if (e.target === overlay) {
      window.dispatchEvent(new CustomEvent('search:close'));
    }
  });

  // Focus trap
  modal?.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;

    const focusableElements = modal.querySelectorAll('input, button, a[href]');
    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    if (e.shiftKey) {
      if (document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      }
    } else {
      if (document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  });

  // Listen for open/close events
  window.addEventListener('search:open', () => {
    overlay?.classList.add(modalStyles.open);
    document.body.style.overflow = 'hidden';
  });

  window.addEventListener('search:close', () => {
    overlay?.classList.remove(modalStyles.open);
    document.body.style.overflow = '';
  });
</script>
