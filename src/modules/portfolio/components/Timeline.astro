---
import styles from "./Timeline.module.css";
import TimelineItem from "./TimelineItem.astro";

interface Props {
  title?: string;
}

const { title = "Experience" } = Astro.props;

interface Role {
  title: string;
  start: string;
  end: string | null;
}

interface CompanyExperience {
  company: string;
  location: string;
  roles: Role[];
}

const experiences: CompanyExperience[] = [
  {
    company: "Constructor Tech",
    location: "Belgrade, Serbia (Hybrid)",
    roles: [
      {
        title: "Frontend Team Lead",
        start: "2025-01",
        end: null,
      },
      {
        title: "Senior Frontend Engineer",
        start: "2024-12",
        end: "2025-01",
      },
    ],
  },
  {
    company: "Citrus Systems",
    location: "Belgrade, Serbia",
    roles: [
      {
        title: "Lead Front-End Developer",
        start: "2021-07",
        end: "2024-10",
      },
      {
        title: "Front-End Developer",
        start: "2020-08",
        end: "2021-06",
      },
    ],
  },
  {
    company: "Boca Tech",
    location: "Belgrade, Serbia",
    roles: [
      {
        title: "Front-End Web Developer",
        start: "2018-05",
        end: "2019-03",
      },
    ],
  },
];

const monthFormatter = new Intl.DateTimeFormat("en-US", {
  month: "short",
  year: "numeric",
});

const parseYearMonth = (value: string) => {
  const [year, month] = value.split("-").map(Number);
  return { year, month };
};

const compareYearMonth = (
  left: { year: number; month: number },
  right: { year: number; month: number },
) => {
  if (left.year !== right.year) {
    return left.year - right.year;
  }

  return left.month - right.month;
};

const formatPeriod = (start: string, end: string | null) => {
  const startParts = parseYearMonth(start);
  const startDate = new Date(startParts.year, startParts.month - 1, 1);

  if (!end) {
    return `${monthFormatter.format(startDate)} - Present`;
  }

  const endParts = parseYearMonth(end);
  const endDate = new Date(endParts.year, endParts.month - 1, 1);
  return `${monthFormatter.format(startDate)} - ${monthFormatter.format(endDate)}`;
};

const getMonthSpan = (start: string, end: string | null) => {
  const startParts = parseYearMonth(start);
  const endParts = end
    ? parseYearMonth(end)
    : {
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
      };

  return (
    (endParts.year - startParts.year) * 12 +
    (endParts.month - startParts.month) +
    1
  );
};

const formatDuration = (months: number) => {
  if (months < 12) {
    return `${months} month${months === 1 ? "" : "s"}`;
  }

  const years = Math.floor(months / 12);
  const remainder = months % 12;

  if (remainder === 0) {
    return `${years} year${years === 1 ? "" : "s"}`;
  }

  return `${years} year${years === 1 ? "" : "s"} ${remainder} month${remainder === 1 ? "" : "s"}`;
};

const enrichedExperiences = experiences.map((companyGroup) => {
  const sortedRoles = [...companyGroup.roles].sort((a, b) =>
    compareYearMonth(parseYearMonth(b.start), parseYearMonth(a.start)),
  );
  const starts = sortedRoles.map((role) => parseYearMonth(role.start));
  const ends = sortedRoles.map((role) =>
    role.end ? parseYearMonth(role.end) : null,
  );

  const earliestStart = starts.reduce((current, candidate) =>
    compareYearMonth(candidate, current) < 0 ? candidate : current,
  );

  const hasPresent = ends.some((entry) => entry === null);
  const latestEnd = hasPresent
    ? null
    : ends
        .filter(
          (entry): entry is { year: number; month: number } => entry !== null,
        )
        .reduce((current, candidate) =>
          compareYearMonth(candidate, current) > 0 ? candidate : current,
        );

  const rangeLabel = hasPresent
    ? `${earliestStart.year} - Present`
    : latestEnd && earliestStart.year !== latestEnd.year
      ? `${earliestStart.year} - ${latestEnd.year}`
      : `${earliestStart.year}`;

  const companyPeriod = formatPeriod(
    `${earliestStart.year}-${String(earliestStart.month).padStart(2, "0")}`,
    latestEnd
      ? `${latestEnd.year}-${String(latestEnd.month).padStart(2, "0")}`
      : null,
  );
  const companyDuration = formatDuration(
    getMonthSpan(
      `${earliestStart.year}-${String(earliestStart.month).padStart(2, "0")}`,
      latestEnd
        ? `${latestEnd.year}-${String(latestEnd.month).padStart(2, "0")}`
        : null,
    ),
  );

  return {
    ...companyGroup,
    roles: sortedRoles.map((role) => ({
      ...role,
      period: formatPeriod(role.start, role.end),
      duration: formatDuration(getMonthSpan(role.start, role.end)),
      isCurrent: role.end === null,
    })),
    rangeLabel,
    companyPeriod,
    companyDuration,
    sortDate: hasPresent
      ? new Date()
      : new Date(
          (latestEnd ?? earliestStart).year,
          (latestEnd ?? earliestStart).month - 1,
          1,
        ),
  };
});

const sortedExperiences = [...enrichedExperiences].sort(
  (a, b) => b.sortDate.valueOf() - a.sortDate.valueOf(),
);
---

<section class={styles.section}>
  <h2 class={styles.heading}>{title}</h2>
  <div class={styles.timeline}>
    {
      sortedExperiences.map((companyGroup) => (
        <div class={styles.yearGroup}>
          <div class={styles.yearMarker}>
            <span class={styles.year}>{companyGroup.rangeLabel}</span>
            <span class={styles.line} />
          </div>
          <div class={styles.groupContent}>
            <div class={styles.companyHeader}>
              <h3 class={styles.company}>{companyGroup.company}</h3>
              <p class={styles.location}>{companyGroup.location}</p>
              <p class={styles.companyMeta}>
                {companyGroup.companyPeriod} Â· {companyGroup.companyDuration}
              </p>
            </div>
            <div class={styles.roles}>
              {companyGroup.roles.map((role) => (
                <TimelineItem
                  title={role.title}
                  period={role.period}
                  duration={role.duration}
                  isCurrent={role.isCurrent}
                />
              ))}
            </div>
          </div>
        </div>
      ))
    }
  </div>
</section>
